import os
from weasyprint import HTML
from jinja2 import Template
import logging

def generate_pdf(output_path, data):
    """
    Generate a styled PDF report with a cover page matching the provided design.

    Args:
        output_path (str): Path to save the PDF.
        data (dict): Must include 'date', 'title', 'recipient', and 'engineer'.
    """
    try:
        curr_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        logo_path = os.path.join(curr_dir, 'static', 'images', 'logo.svg')

        with open(logo_path, 'r') as f:
            logo_svg = f.read()

        html_template = """
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>PDF Cover</title>
            <style>
                @page {
                    size: A4;
                    margin: 0;
                }
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    position: relative;
                }
                .container {
                    width: 100%;
                    height: 100vh;
                    padding: 60px 50px;
                    box-sizing: border-box;
                    position: relative;
                }
                .top-title {
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 20px;
                    text-decoration: underline;
                }
                .meta-right {
                    position: absolute;
                    top: 90px;
                    right: 50px;
                    font-size: 12px;
                    text-align: right;
                }
                .meta-right .label {
                    font-weight: bold;
                }
                .meta-right .value {
                    margin-bottom: 4px;
                }
                .date {
                    position: absolute;
                    top: 90px;
                    left: 50px;
                    font-size: 10px;
                }
                .main-title {
                    margin-top: 180px;
                    text-align: center;
                    font-size: 24px;
                    font-weight: bold;
                    line-height: 1.4;
                }
                .prepared-by {
                    position: absolute;
                    bottom: 260px;
                    right: 50px;
                    font-size: 10px;
                    text-align: right;
                }
                .logo {
                    width: 120px;
                    margin: 0 auto;
                    margin-bottom: 20px;
                }
                .logo-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-top: 50px;
                }
                .company-name {
                    text-align: center;
                    font-size: 20px;
                    font-weight: bold;
                    margin-top: 10px;
                }
                .footer {
                    position: absolute;
                    bottom: 20px;
                    width: 100%;
                    text-align: center;
                    font-size: 7px;
                    color: #777;
                    padding: 0 20px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="top-title">Solution Overview</div>
                <div class="date">{{ data.date }}</div>
                
                <div class="meta-right">
                    <div class="value"><span class="label">Prepared For:</span><br>{{ data.recipient }}</div>
                </div>
                
                <div class="main-title">
                    {{ data.title.split(":")[0] }}:<br>
                    {{ data.title.split(":")[1] }}
                </div>
                
                <div class="prepared-by">
                    <div>Prepared By:<br>{{ data.engineer }}<br>Solutions Engineer<br><strong>DRY GROUND AI</strong></div>
                </div>
                
                <div class="logo-container">
                    <div class="logo">{{ logo_svg|safe }}</div>
                </div>
                
                <div class="company-name">DRY GROUND AI</div>

                <div class="footer">
                    This document and the information contained herein are the confidential and proprietary property of Dry Ground AI. 
                    It is intended solely for the use of the recipient(s) and may not be copied, distributed, reproduced, or disclosed—whether in whole or part—without the express written consent of Dry Ground AI. 
                    Unauthorized use, disclosure, or duplication is strictly prohibited. All rights reserved © {{ data.date[-4:] }}.
                </div>
            </div>
        </body>
        </html>
        """

        template = Template(html_template)
        html_content = template.render(data=data, logo_svg=logo_svg)
        HTML(string=html_content).write_pdf(output_path)
        logging.info(f"PDF successfully generated at {output_path}")
        return True

    except Exception as e:
        logging.error(f"PDF generation failed: {str(e)}")
        raise
