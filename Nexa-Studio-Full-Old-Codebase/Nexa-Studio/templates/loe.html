<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRY GROUND AI - Level of Effort</title>
    
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Header and Footer Styling */
        .header {
            background-color: #000;
            color: #fff;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            flex: 0 0 auto;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex: 1;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            flex: 0 0 auto;
        }
        
        .system-icon {
            width: 28px;
            height: 28px;
            fill: #fff;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.8s ease;
        }
        
        .system-icon:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }
        
        .nav-item {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .nav-item:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .nav-item.clickable {
            position: relative;
        }
        
        .nav-item.clickable:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .nav-item.active {
            color: #007bff;
        }
        
        .nav-separator {
            color: #666;
            font-weight: 300;
            user-select: none;
        }
        
        .header .logo-img {
            height: 40px;
            width: auto;
            filter: invert(1);
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.8s ease;
        }
        
        .header .logo-img:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        
        .chat-btn {
            background: linear-gradient(45deg, #00ff88, #00ccff, #ff00ff, #ffff00);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: neon-gradient 3s ease-in-out infinite;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
        }
        
        .chat-btn:hover {
            transform: translateY(-1px);
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.5));
        }
        
        @keyframes neon-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-center {
                gap: 12px;
                position: static;
                transform: none;
                flex: 1;
                margin: 0 20px;
            }
            
            .nav-item {
                font-size: 14px;
                padding: 6px 8px;
            }
            
            .chat-btn {
                font-size: 14px;
                padding: 6px 12px;
            }
            
            .system-icon {
                width: 28px;
                height: 28px;
            }
        }
        
        @media (max-width: 576px) {
            .header-center {
                gap: 8px;
            }
            
            .nav-item {
                font-size: 12px;
                padding: 4px 6px;
            }
            
            .header .logo-img {
                height: 32px;
            }
        }
        
        .footer {
            background-color: #000;
            color: #fff;
            padding: 30px 0;
            margin-top: auto;
            border-top: 1px solid #333;
        }
        
        .footer .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .footer .footer-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .footer .footer-links a {
            color: #fff;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer .footer-links a:hover {
            color: #00ff88;
        }
        
        .footer .copyright {
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        /* Main content styling */
        .main-content {
            flex: 1;
            padding: 40px 0;
            min-height: calc(100vh - 120px);
        }
        
        .page-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .content-card {
            background-color: #000000;  /* Pitch black to match main page */
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #495057;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;  /* White text for dark theme */
            margin-bottom: 10px;
            text-align: center;
        }
        
        .page-subtitle {
            font-size: 1.1rem;
            color: #ced4da;  /* Light gray for dark theme */
            text-align: center;
            margin-bottom: 30px;
        }
        
        .coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #ced4da;  /* Light gray for dark theme */
        }
        
        .coming-soon i {
            font-size: 4rem;
            color: #ffffff;  /* White icon for dark theme */
            margin-bottom: 20px;
        }
        
        .coming-soon h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ffffff;  /* White heading for dark theme */
        }
        
        .coming-soon p {
            font-size: 1rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* LoE Form Styling */
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 2px solid #495057;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #ced4da;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #495057;
            padding: 0.75rem;
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #212529;
            color: #e9ecef;
        }

        .form-control:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .form-control::placeholder {
            color: #6c757d;
        }

        .form-text {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            color: #adb5bd;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #000000;
        }

        .btn-primary:hover {
            background-color: #f8f9fa;
            border-color: #f8f9fa;
            color: #000000;
        }

        .btn-outline-primary {
            background-color: transparent;
            border-color: #6c757d;
            color: #ffffff;
        }

        .btn-outline-primary:hover {
            background-color: #495057;
            border-color: #6c757d;
            color: #ffffff;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #ffffff;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
            color: #ffffff;
        }

        .btn i {
            width: 16px;
            height: 16px;
        }

        /* Workstream Table Styling */
        .workstream-table {
            background-color: #212529;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #495057;
        }

        .workstream-table table {
            margin-bottom: 0;
        }

        .workstream-table th {
            background-color: #343a40;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 2px solid #495057;
            padding: 1rem;
        }

        .workstream-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #495057;
            vertical-align: middle;
        }

        .workstream-table tr:last-child td {
            border-bottom: none;
        }

        .workstream-table input {
            background-color: transparent;
            border: 1px solid #495057;
            color: #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            width: 100%;
        }

        .workstream-table input:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .workstream-table input::placeholder {
            color: #6c757d;
        }

        .workstream-table .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .add-workstream-btn {
            margin-top: 1rem;
        }

        .section-divider {
            border-top: 1px solid #495057;
            margin: 2rem 0;
        }

        .form-actions {
            border-top: 1px solid #495057;
            padding-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Alert styling for better visibility */
        .alert {
            border: none;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #155724;
            color: #d4edda;
        }

        .alert-danger {
            background-color: #721c24;
            color: #f8d7da;
        }

        .alert-info {
            background-color: #0c5460;
            color: #d1ecf1;
        }

        /* Multi-step form styling */
        .step-container {
            display: none;
        }

        .step-container.active {
            display: block;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #495057;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .step-indicator .step-number {
            background-color: #495057;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .step-indicator.active .step-number {
            background-color: #ffffff;
            color: #000000;
        }

        /* Resource allocation table styling */
        .resource-table {
            background-color: #212529;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #495057;
        }

        .resource-table table {
            margin-bottom: 0;
        }

        .resource-table th {
            background-color: #343a40;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 2px solid #495057;
            padding: 1rem;
        }

        .resource-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #495057;
            vertical-align: middle;
        }

        .resource-table tr:last-child td {
            border-bottom: none;
        }

        .resource-table input {
            background-color: transparent;
            border: 1px solid #495057;
            color: #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            width: 100%;
        }

        .resource-table input:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .resource-table input::placeholder {
            color: #6c757d;
        }

        .resource-table .fixed-row {
            background-color: #2c3034;
            font-weight: 600;
        }

        .resource-table .total-row {
            background-color: #1a1d20;
            font-weight: 700;
            color: #ffffff;
        }

        .resource-table .total-row input {
            background-color: #343a40;
            border-color: #6c757d;
            font-weight: 700;
            cursor: not-allowed;
        }

        /* Key assumptions styling */
        .assumption-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: flex-start;
        }

        .assumption-item textarea {
            flex: 1;
            resize: vertical;
            min-height: 60px;
        }

        .assumption-item .btn-sm {
            margin-top: 0.5rem;
        }

        .add-assumption-btn {
            margin-top: 1rem;
        }
    </style>
</head>
<body class="page-wrapper">
    <!-- Header -->
    <header class="header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="header-container p-3">
                        <!-- Left section -->
                        <div class="header-left">
                            <img src="{{ url_for('static', filename='img/dg.png') }}" alt="DRY GROUND AI" class="logo-img" onclick="window.location.href='/solutioning'">
                        </div>
                        
                        <!-- Center section -->
                        <div class="header-center">
                            <a href="/solutioning" class="nav-item clickable">Solutioning</a>
                            <span class="nav-separator">|</span>
                            <a href="/sow" class="nav-item clickable">SoW</a>
                            <span class="nav-separator">|</span>
                            <a href="/loe" class="nav-item active">LoE</a>
                            <span class="nav-separator">|</span>
                            <a href="/structuring" class="nav-item clickable">Structuring</a>
                            <span class="nav-separator">|</span>
                            <a href="/visuals" class="nav-item clickable">Visuals</a>
                            <span class="nav-separator">|</span>
                            <a href="/arsenal" class="nav-item clickable">Arsenal</a>
                            <span class="nav-separator">|</span>
                            <a href="/sessions" class="nav-item clickable">Sessions</a>
                        </div>
                        
                        <!-- Right section -->
                        <div class="header-right">
                            <span class="chat-btn">DRY GROUND AI</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="content-card">
                        <h1 class="page-title">Level of Effort</h1>
                        <p class="page-subtitle">Estimate project complexity and resource requirements</p>
                        
                        <!-- LoE Form -->
                        <form id="loeForm">
                            <!-- Step 1: Overview & Workstreams -->
                            <div class="step-container active" id="step1">
                                <!-- Basic Information Section -->
                                <div class="step-title">
                                    <i data-feather="info"></i>
                                    Basic Information
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="projectName">Project Name</label>
                                            <input type="text" class="form-control" id="projectName" name="projectName" placeholder="Enter project name..." required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="client">Client</label>
                                            <input type="text" class="form-control" id="client" name="client" placeholder="Enter client name..." required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="preparedBy">Prepared By</label>
                                            <input type="text" class="form-control" id="preparedBy" name="preparedBy" placeholder="Enter your name..." required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="date">Date</label>
                                            <input type="date" class="form-control" id="date" name="date" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Overview Section -->
                                <div class="step-title">
                                    <i data-feather="file-text"></i>
                                    Project Overview
                                </div>
                                
                                <div class="form-group">
                                    <label for="projectOverview">Project Overview</label>
                                    <textarea 
                                        class="form-control" 
                                        id="projectOverview" 
                                        name="projectOverview" 
                                        rows="6" 
                                        placeholder="Provide a comprehensive overview of the project, including objectives, scope, and key requirements..."
                                    ></textarea>
                                    <div class="form-text">Describe the project's purpose, goals, and high-level requirements to help estimate effort accurately.</div>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Workstreams Section -->
                                <div class="step-title">
                                    <i data-feather="layers"></i>
                                    Workstreams
                                </div>
                                
                                <div class="form-group">
                                    <label>Project Workstreams</label>
                                    <div class="form-text mb-3">Break down the project into distinct workstreams with key activities and duration estimates.</div>
                                    
                                    <div class="workstream-table">
                                        <table class="table table-dark mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 35%;">Workstream</th>
                                                    <th style="width: 45%;">Key Activities</th>
                                                    <th style="width: 15%;">Duration (wks)</th>
                                                    <th style="width: 5%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="workstreamTableBody">
                                                <tr>
                                                    <td>
                                                        <input type="text" class="form-control" placeholder="e.g., Requirements Analysis" name="workstream[]">
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control" placeholder="e.g., Stakeholder interviews, documentation review" name="activities[]">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="2" min="1" name="duration[]">
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeWorkstream(this)" title="Remove workstream">
                                                            <i data-feather="trash-2"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary add-workstream-btn" onclick="addWorkstream()">
                                        <i data-feather="plus"></i>
                                        Add Workstream
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: Resource Allocation & Assumptions -->
                            <div class="step-container" id="step2">
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2 mb-4">
                                    <button type="button" id="previewLoePdfBtn" class="btn btn-info btn-sm" style="width: 32px; height: 32px; padding: 6px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Preview PDF">
                                        <i data-feather="file-text" style="width: 16px; height: 16px;"></i>
                                    </button>
                                    <button type="button" id="generateLoePdfBtn" class="btn btn-success btn-sm" style="width: 32px; height: 32px; padding: 6px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Generate PDF">
                                        <i data-feather="download" style="width: 16px; height: 16px;"></i>
                                    </button>
                                    <button type="button" id="saveLoEBtn" class="btn btn-dark btn-sm" style="width: 96px; height: 32px; padding: 6px 12px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Save LoE">
                                        <i data-feather="save" style="width: 16px; height: 16px; margin-right: 4px;"></i>Save
                                    </button>
                                    <button type="button" id="saveLoEToDbBtn" class="btn btn-warning btn-sm" style="width: 32px; height: 32px; padding: 6px; display: none;" data-bs-toggle="tooltip" data-bs-placement="top" title="Save to Database">
                                        <i data-feather="database" style="width: 16px; height: 16px;"></i>
                                    </button>
                                    <button type="button" id="deleteLoEBtn" class="btn btn-danger btn-sm" style="width: 32px; height: 32px; padding: 6px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete LoE">
                                        <i data-feather="trash-2" style="width: 16px; height: 16px;"></i>
                                    </button>
                                </div>

                                <!-- Resource Allocation Section -->
                                <div class="step-title">
                                    <i data-feather="users"></i>
                                    Resource Allocation
                                </div>
                                
                                <div class="form-group">
                                    <label>Resource Requirements</label>
                                    <div class="form-text mb-3">Define the roles and effort required for the project.</div>
                                    
                                    <div class="resource-table">
                                        <table class="table table-dark mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 40%;">Role</th>
                                                    <th style="width: 25%;">Person-Weeks</th>
                                                    <th style="width: 25%;">Person-Hours</th>
                                                    <th style="width: 10%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resourceTableBody">
                                                <tr>
                                                    <td>
                                                        <input type="text" class="form-control" placeholder="e.g., Project Manager" name="role[]">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="2.0" step="0.5" min="0" name="personWeeks[]" onchange="updatePersonHours(this)">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="80" step="10" min="0" name="personHours[]" onchange="updatePersonWeeks(this)">
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeResource(this)" title="Remove role">
                                                            <i data-feather="trash-2"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody id="resourceFixedRows">
                                                <tr class="fixed-row">
                                                    <td>
                                                        <strong>Buffer Margin (all roles)</strong>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="1.0" step="0.5" min="0" name="bufferWeeks" onchange="updateBufferHours()">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="40" step="10" min="0" name="bufferHours" onchange="updateBufferWeeks()">
                                                    </td>
                                                    <td></td>
                                                </tr>
                                                <tr class="total-row">
                                                    <td>
                                                        <strong>Total</strong>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="totalWeeks" readonly>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="totalHours" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary add-workstream-btn" onclick="addResource()">
                                        <i data-feather="plus"></i>
                                        Add Role
                                    </button>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Key Assumptions Section -->
                                <div class="step-title">
                                    <i data-feather="clipboard"></i>
                                    Key Assumptions
                                </div>
                                
                                <div class="form-group">
                                    <label>Project Assumptions</label>
                                    <div class="form-text mb-3">Document key assumptions that impact the level of effort estimation.</div>
                                    
                                    <div id="assumptionsContainer">
                                        <div class="assumption-item">
                                            <textarea class="form-control" placeholder="e.g., Client will provide all required documentation within 2 weeks" name="assumption[]"></textarea>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeAssumption(this)" title="Remove assumption">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary add-assumption-btn" onclick="addAssumption()">
                                        <i data-feather="plus"></i>
                                        Add Assumption
                                    </button>
                                </div>

                                <div class="section-divider"></div>

                                <!-- Options Section -->
                                <div class="step-title">
                                    <i data-feather="sliders"></i>
                                    Options
                                </div>

                                <div class="form-group">
                                    <label>Project Scaling Options</label>
                                    <div class="form-text mb-3">Adjust project scope with pre-defined feature sets that impact timeline and budget.</div>
                                </div>

                                <!-- Good (Lower Effort) Table -->
                                <div class="form-group">
                                    <label class="d-flex align-items-center mb-3">
                                        <i data-feather="minus-circle" class="me-2" style="color: #28a745;"></i>
                                        Good (Lower Effort Option)
                                    </label>
                                    
                                    <div class="resource-table">
                                        <table class="table table-dark mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 50%;">Features Removed</th>
                                                    <th style="width: 20%;">Person-Hours</th>
                                                    <th style="width: 20%;">Person-Weeks</th>
                                                    <th style="width: 10%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="goodOptionsTableBody">
                                                <tr>
                                                    <td>
                                                        <textarea class="form-control" rows="2" placeholder="e.g., AI-generated draft replies and promotional automation" name="goodFeature[]"></textarea>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="40" step="10" min="0" name="goodHours[]" onchange="updateGoodWeeks(this)">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="2.0" step="0.5" min="0" name="goodWeeks[]" onchange="updateGoodHours(this)">
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeGoodFeature(this)" title="Remove feature">
                                                            <i data-feather="trash-2"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody id="goodOptionsFixedRows">
                                                <tr class="fixed-row">
                                                    <td><strong>Decrease in Project Duration</strong></td>
                                                    <td>
                                                        <input type="number" class="form-control" id="goodTotalHours" readonly>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="goodTotalWeeks" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                                <tr class="total-row">
                                                    <td><strong>Adjusted LOE</strong></td>
                                                    <td>
                                                        <input type="number" class="form-control" id="goodAdjustedHours" readonly>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="goodAdjustedWeeks" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-danger add-workstream-btn" onclick="addGoodFeature()">
                                        <i data-feather="plus"></i>
                                        Add Removed Feature
                                    </button>
                                </div>

                                <!-- Best (Enhanced) Table -->
                                <div class="form-group mt-5">
                                    <label class="d-flex align-items-center mb-3">
                                        <i data-feather="plus-circle" class="me-2" style="color: #007bff;"></i>
                                        Best (Enhanced Option)
                                    </label>
                                    
                                    <div class="resource-table">
                                        <table class="table table-dark mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width: 50%;">Features Added</th>
                                                    <th style="width: 20%;">Person-Hours</th>
                                                    <th style="width: 20%;">Person-Weeks</th>
                                                    <th style="width: 10%;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bestOptionsTableBody">
                                                <tr>
                                                    <td>
                                                        <textarea class="form-control" rows="2" placeholder="e.g., AI Business Intelligence with predictive analytics" name="bestFeature[]"></textarea>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="60" step="10" min="0" name="bestHours[]" onchange="updateBestWeeks(this)">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" placeholder="3.0" step="0.5" min="0" name="bestWeeks[]" onchange="updateBestHours(this)">
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeBestFeature(this)" title="Remove feature">
                                                            <i data-feather="trash-2"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody id="bestOptionsFixedRows">
                                                <tr class="fixed-row">
                                                    <td><strong>Increase in Project Duration</strong></td>
                                                    <td>
                                                        <input type="number" class="form-control" id="bestTotalHours" readonly>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="bestTotalWeeks" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                                <tr class="total-row">
                                                    <td><strong>Adjusted LOE</strong></td>
                                                    <td>
                                                        <input type="number" class="form-control" id="bestAdjustedHours" readonly>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" id="bestAdjustedWeeks" readonly>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary add-workstream-btn" onclick="addBestFeature()">
                                        <i data-feather="plus"></i>
                                        Add Enhanced Feature
                                    </button>
                                </div>

                                <div class="section-divider"></div>
                            </div>

                            <!-- Step Navigation -->
                            <div class="step-navigation">
                                <div class="step-indicator" id="step1Indicator">
                                    <div class="step-number">1</div>
                                    <span>Overview & Workstreams</span>
                                </div>
                                
                                <div class="step-indicator" id="step2Indicator">
                                    <div class="step-number">2</div>
                                    <span>Resources & Assumptions</span>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="button" class="btn btn-outline-primary" id="prevBtn" onclick="previousStep()" style="display: none;">
                                        <i data-feather="arrow-left"></i>
                                        Previous
                                    </button>
                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                                        Next
                                        <i data-feather="arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="/solutioning">Solutions</a>
                    <a href="/sow">Statement of Work</a>
                    <a href="/loe">Level of Effort</a>
                    <a href="/structuring">Structuring</a>
                    <a href="/visuals">Visuals</a>
                    <a href="/arsenal">Arsenal</a>
                    <a href="/sessions">Sessions</a>
                </div>
                <div class="copyright">
                    © 2024 DRY GROUND AI. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>

    <!-- LoE JavaScript -->
    <script>
        // Session ID from the server
        const sessionId = '{{ session_id }}';
        let currentStep = 1;
        
        // Multi-step navigation
        function nextStep() {
            if (currentStep === 1) {
                // Validate step 1 before proceeding
                const formData = collectFormData();
                if (!validateStep1(formData)) {
                    return;
                }
                
                // Update session with current data
                console.log('🔄 Auto-updating session before moving to step 2');
                updateSession(formData).then(() => {
                    currentStep = 2;
                    showStep(2);
                }).catch(error => {
                    console.error('Failed to update session:', error);
                    showMessage('Error saving data: ' + error.message, 'error');
                });
            }
        }
        
        function previousStep() {
            if (currentStep === 2) {
                currentStep = 1;
                showStep(1);
            }
        }
        
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            document.getElementById(`step${step}Indicator`).classList.add('active');
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (step === 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'inline-flex';
            } else if (step === 2) {
                prevBtn.style.display = 'inline-flex';
                nextBtn.style.display = 'none';
            }
            
            // Re-initialize feather icons
            feather.replace();
        }
        
        // Add new workstream row
        function addWorkstream() {
            const tableBody = document.getElementById('workstreamTableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control" placeholder="e.g., Development & Testing" name="workstream[]">
                </td>
                <td>
                    <input type="text" class="form-control" placeholder="e.g., Code development, unit testing, integration" name="activities[]">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="4" min="1" name="duration[]">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeWorkstream(this)" title="Remove workstream">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            feather.replace();
        }
        
        // Remove workstream row
        function removeWorkstream(button) {
            const row = button.closest('tr');
            const tableBody = document.getElementById('workstreamTableBody');
            
            if (tableBody.children.length > 1) {
                row.remove();
            } else {
                alert('At least one workstream is required.');
            }
        }
        
        // Add new resource row
        function addResource() {
            const tableBody = document.getElementById('resourceTableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <input type="text" class="form-control" placeholder="e.g., Software Developer" name="role[]">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="4.0" step="0.5" min="0" name="personWeeks[]" onchange="updatePersonHours(this)">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="160" step="10" min="0" name="personHours[]" onchange="updatePersonWeeks(this)">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeResource(this)" title="Remove role">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            feather.replace();
            calculateTotals();
        }
        
        // Remove resource row
        function removeResource(button) {
            const row = button.closest('tr');
            const tableBody = document.getElementById('resourceTableBody');
            
            if (tableBody.children.length > 1) {
                row.remove();
                calculateTotals();
            } else {
                alert('At least one role is required.');
            }
        }
        
        // Update person-hours when person-weeks changes
        function updatePersonHours(weeksInput) {
            const row = weeksInput.closest('tr');
            const hoursInput = row.querySelector('input[name="personHours[]"]');
            const weeks = parseFloat(weeksInput.value) || 0;
            const hours = weeks * 20; // Assuming 20 hours per week
            hoursInput.value = hours;
            calculateTotals();
        }
        
        // Update person-weeks when person-hours changes
        function updatePersonWeeks(hoursInput) {
            const row = hoursInput.closest('tr');
            const weeksInput = row.querySelector('input[name="personWeeks[]"]');
            const hours = parseFloat(hoursInput.value) || 0;
            const weeks = (hours / 20).toFixed(1); // Assuming 20 hours per week
            weeksInput.value = weeks;
            calculateTotals();
        }
        
        // Update buffer hours when buffer weeks changes
        function updateBufferHours() {
            const weeksInput = document.querySelector('input[name="bufferWeeks"]');
            const hoursInput = document.querySelector('input[name="bufferHours"]');
            const weeks = parseFloat(weeksInput.value) || 0;
            const hours = weeks * 20;
            hoursInput.value = hours;
            calculateTotals();
        }
        
        // Update buffer weeks when buffer hours changes
        function updateBufferWeeks() {
            const hoursInput = document.querySelector('input[name="bufferHours"]');
            const weeksInput = document.querySelector('input[name="bufferWeeks"]');
            const hours = parseFloat(hoursInput.value) || 0;
            const weeks = (hours / 20).toFixed(1);
            weeksInput.value = weeks;
            calculateTotals();
        }
        
        // Calculate totals for resource allocation
        function calculateTotals() {
            let totalWeeks = 0;
            let totalHours = 0;
            
            // Sum regular roles
            const resourceRows = document.querySelectorAll('#resourceTableBody tr');
            resourceRows.forEach(row => {
                const weeks = parseFloat(row.querySelector('input[name="personWeeks[]"]').value) || 0;
                const hours = parseFloat(row.querySelector('input[name="personHours[]"]').value) || 0;
                totalWeeks += weeks;
                totalHours += hours;
            });
            
            // Add buffer
            const bufferWeeks = parseFloat(document.querySelector('input[name="bufferWeeks"]').value) || 0;
            const bufferHours = parseFloat(document.querySelector('input[name="bufferHours"]').value) || 0;
            totalWeeks += bufferWeeks;
            totalHours += bufferHours;
            
            // Update totals
            document.getElementById('totalWeeks').value = totalWeeks.toFixed(1);
            document.getElementById('totalHours').value = totalHours.toFixed(0);
            
            // Update Good/Best adjusted totals whenever base totals change
            updateGoodBestAdjustedTotals();
        }
        
        // Add new assumption
        function addAssumption() {
            const container = document.getElementById('assumptionsContainer');
            const newAssumption = document.createElement('div');
            newAssumption.className = 'assumption-item';
            
            newAssumption.innerHTML = `
                <textarea class="form-control" placeholder="e.g., All stakeholders will be available for regular review meetings" name="assumption[]"></textarea>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeAssumption(this)" title="Remove assumption">
                    <i data-feather="trash-2"></i>
                </button>
            `;
            
            container.appendChild(newAssumption);
            feather.replace();
        }
        
        // Remove assumption
        function removeAssumption(button) {
            const assumptionItem = button.closest('.assumption-item');
            const container = document.getElementById('assumptionsContainer');
            
            if (container.children.length > 1) {
                assumptionItem.remove();
            } else {
                alert('At least one assumption is required.');
            }
        }
        
        // Good Options Functions
        function addGoodFeature() {
            const tableBody = document.getElementById('goodOptionsTableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <textarea class="form-control" rows="2" placeholder="Describe removed feature..." name="goodFeature[]"></textarea>
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="20" step="10" min="0" name="goodHours[]" onchange="updateGoodWeeks(this)">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="1.0" step="0.5" min="0" name="goodWeeks[]" onchange="updateGoodHours(this)">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeGoodFeature(this)" title="Remove feature">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            feather.replace();
            calculateGoodTotals();
        }
        
        function removeGoodFeature(button) {
            const row = button.closest('tr');
            const tableBody = document.getElementById('goodOptionsTableBody');
            
            if (tableBody.children.length > 1) {
                row.remove();
                calculateGoodTotals();
            } else {
                alert('At least one good option is required.');
            }
        }
        
        function updateGoodWeeks(hoursInput) {
            const row = hoursInput.closest('tr');
            const weeksInput = row.querySelector('input[name="goodWeeks[]"]');
            const hours = parseFloat(hoursInput.value) || 0;
            const weeks = (hours / 20).toFixed(1);
            weeksInput.value = weeks;
            calculateGoodTotals();
        }
        
        function updateGoodHours(weeksInput) {
            const row = weeksInput.closest('tr');
            const hoursInput = row.querySelector('input[name="goodHours[]"]');
            const weeks = parseFloat(weeksInput.value) || 0;
            const hours = weeks * 20;
            hoursInput.value = hours;
            calculateGoodTotals();
        }
        
        function calculateGoodTotals() {
            let totalHours = 0;
            const goodRows = document.querySelectorAll('#goodOptionsTableBody tr');
            
            goodRows.forEach(row => {
                const hours = parseFloat(row.querySelector('input[name="goodHours[]"]').value) || 0;
                totalHours += hours;
            });
            
            const totalWeeks = (totalHours / 20).toFixed(1);
            
            document.getElementById('goodTotalHours').value = totalHours;
            document.getElementById('goodTotalWeeks').value = totalWeeks;
            
            // Calculate adjusted LOE (base totals - good totals)
            const baseTotalHours = parseFloat(document.getElementById('totalHours').value) || 0;
            const baseTotalWeeks = parseFloat(document.getElementById('totalWeeks').value) || 0;
            
            const adjustedHours = baseTotalHours - totalHours;
            const adjustedWeeks = (adjustedHours / 20).toFixed(1);
            
            document.getElementById('goodAdjustedHours').value = adjustedHours;
            document.getElementById('goodAdjustedWeeks').value = adjustedWeeks;
        }
        
        // Best Options Functions
        function addBestFeature() {
            const tableBody = document.getElementById('bestOptionsTableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <textarea class="form-control" rows="2" placeholder="Describe enhanced feature..." name="bestFeature[]"></textarea>
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="30" step="10" min="0" name="bestHours[]" onchange="updateBestWeeks(this)">
                </td>
                <td>
                    <input type="number" class="form-control" placeholder="1.5" step="0.5" min="0" name="bestWeeks[]" onchange="updateBestHours(this)">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeBestFeature(this)" title="Remove feature">
                        <i data-feather="trash-2"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            feather.replace();
            calculateBestTotals();
        }
        
        function removeBestFeature(button) {
            const row = button.closest('tr');
            const tableBody = document.getElementById('bestOptionsTableBody');
            
            if (tableBody.children.length > 1) {
                row.remove();
                calculateBestTotals();
            } else {
                alert('At least one best option is required.');
            }
        }
        
        function updateBestWeeks(hoursInput) {
            const row = hoursInput.closest('tr');
            const weeksInput = row.querySelector('input[name="bestWeeks[]"]');
            const hours = parseFloat(hoursInput.value) || 0;
            const weeks = (hours / 20).toFixed(1);
            weeksInput.value = weeks;
            calculateBestTotals();
        }
        
        function updateBestHours(weeksInput) {
            const row = weeksInput.closest('tr');
            const hoursInput = row.querySelector('input[name="bestHours[]"]');
            const weeks = parseFloat(weeksInput.value) || 0;
            const hours = weeks * 20;
            hoursInput.value = hours;
            calculateBestTotals();
        }
        
        function calculateBestTotals() {
            let totalHours = 0;
            const bestRows = document.querySelectorAll('#bestOptionsTableBody tr');
            
            bestRows.forEach(row => {
                const hours = parseFloat(row.querySelector('input[name="bestHours[]"]').value) || 0;
                totalHours += hours;
            });
            
            const totalWeeks = (totalHours / 20).toFixed(1);
            
            document.getElementById('bestTotalHours').value = totalHours;
            document.getElementById('bestTotalWeeks').value = totalWeeks;
            
            // Calculate adjusted LOE (base totals + best totals)
            const baseTotalHours = parseFloat(document.getElementById('totalHours').value) || 0;
            const baseTotalWeeks = parseFloat(document.getElementById('totalWeeks').value) || 0;
            
            const adjustedHours = baseTotalHours + totalHours;
            const adjustedWeeks = (adjustedHours / 20).toFixed(1);
            
            document.getElementById('bestAdjustedHours').value = adjustedHours;
            document.getElementById('bestAdjustedWeeks').value = adjustedWeeks;
        }
        
        // Update existing calculateTotals function to also update Good/Best adjusted values
        function updateGoodBestAdjustedTotals() {
            calculateGoodTotals();
            calculateBestTotals();
        }
        
        // Save LoE data
        function saveLoE() {
            const formData = collectFormData();
            
            if (!validateFormData(formData)) {
                return;
            }
            
            // Show loading state
            const saveBtn = document.getElementById('saveLoEBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i data-feather="loader"></i> Saving...';
            saveBtn.disabled = true;
            feather.replace();
            
            // Call saveLoEToDatabase which handles both session update and database save
            updateSession(formData).then(() => {
                // Call save to database endpoint
                return fetch('/save-loe-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sessionId: sessionId })
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('LoE data saved successfully!', 'success');
                } else {
                    throw new Error(data.message || 'Failed to save to database');
                }
            })
            .catch(error => {
                console.error('Error saving LoE data:', error);
                showMessage('Error saving LoE data: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                feather.replace();
            });
        }
        
        // Placeholder functions for action buttons (to be implemented later)
        function previewLoEPdf() {
            // Validate form data first
            const formData = collectFormData();
            if (!validateFormData(formData)) {
                return;
            }
            
            // Update session first, then open preview
            updateSession(formData).then(() => {
                const previewUrl = `/preview-loe-pdf?sessionId=${sessionId}`;
                window.open(previewUrl, '_blank');
            }).catch(error => {
                console.error('Error updating session before preview:', error);
                showMessage('Error preparing PDF preview: ' + error.message, 'error');
            });
        }
        
        function generateLoEPdf() {
            // Validate form data first
            const formData = collectFormData();
            if (!validateFormData(formData)) {
                return;
            }
            
            // Show loading state
            const generateBtn = document.getElementById('generateLoePdfBtn');
            const originalHtml = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i data-feather="loader"></i>';
            generateBtn.disabled = true;
            feather.replace();
            
            // Update session first, then generate PDF
            updateSession(formData).then(() => {
                // Create a form and submit it to trigger download
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/generate-loe-pdf';
                form.style.display = 'none';
                
                const sessionIdInput = document.createElement('input');
                sessionIdInput.type = 'hidden';
                sessionIdInput.name = 'sessionId';
                sessionIdInput.value = sessionId;
                form.appendChild(sessionIdInput);
                
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                // Reset button state
                generateBtn.innerHTML = originalHtml;
                generateBtn.disabled = false;
                feather.replace();
                
                showMessage('LoE PDF generated successfully!', 'success');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF: ' + error.message, 'error');
                
                // Reset button state
                generateBtn.innerHTML = originalHtml;
                generateBtn.disabled = false;
                feather.replace();
            });
        }
        
        function deleteLoE() {
            if (confirm('Are you sure you want to delete this LoE session? This action cannot be undone.')) {
                // Show loading state
                const deleteBtn = document.getElementById('deleteLoEBtn');
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i data-feather="loader"></i>';
                deleteBtn.disabled = true;
                feather.replace();
                
                // Call delete endpoint
                fetch('/delete-loe-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sessionId: sessionId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('LoE session deleted successfully!', 'success');
                        // Redirect to main LoE page after a short delay
                        setTimeout(() => {
                            window.location.href = '/loe';
                        }, 1500);
                    } else {
                        throw new Error(data.message || 'Failed to delete session');
                    }
                })
                .catch(error => {
                    console.error('Error deleting LoE session:', error);
                    showMessage('Error deleting session: ' + error.message, 'error');
                    
                    // Reset button state
                    deleteBtn.innerHTML = originalHtml;
                    deleteBtn.disabled = false;
                    feather.replace();
                });
            }
        }
        
        function saveLoEToDatabase() {
            // Validate form data first
            const formData = collectFormData();
            if (!validateFormData(formData)) {
                return;
            }
            
            // Show loading state
            const saveDbBtn = document.getElementById('saveLoEToDbBtn');
            const originalHtml = saveDbBtn.innerHTML;
            saveDbBtn.innerHTML = '<i data-feather="loader"></i>';
            saveDbBtn.disabled = true;
            feather.replace();
            
            // Update session first, then save to database
            updateSession(formData).then(() => {
                // Call save to database endpoint
                return fetch('/save-loe-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sessionId: sessionId })
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`LoE session saved to database successfully! Row ID: ${data.row_id}`, 'success');
                } else {
                    throw new Error(data.message || 'Failed to save to database');
                }
            })
            .catch(error => {
                console.error('Error saving LoE session to database:', error);
                showMessage('Error saving to database: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset button state
                saveDbBtn.innerHTML = originalHtml;
                saveDbBtn.disabled = false;
                feather.replace();
            });
        }
        
        // Update session data on backend
        function updateSession(formData) {
            console.log('📊 Updating LoE session with data:', formData);
            
            return fetch('/update-loe-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ LoE session updated successfully:', data);
                    console.log('📋 Session ID:', data.sessionId);
                    return data;
                } else {
                    throw new Error(data.error || 'Failed to update session');
                }
            })
            .catch(error => {
                console.error('❌ Error updating LoE session:', error);
                throw error;
            });
        }
        
        // Validate step 1
        function validateStep1(data) {
            // Validate basic information
            if (!data.projectName) {
                showMessage('Please provide a project name.', 'error');
                document.getElementById('projectName').focus();
                return false;
            }
            
            if (!data.client) {
                showMessage('Please provide a client name.', 'error');
                document.getElementById('client').focus();
                return false;
            }
            
            if (!data.preparedBy) {
                showMessage('Please provide who prepared this LoE.', 'error');
                document.getElementById('preparedBy').focus();
                return false;
            }
            
            if (!data.date) {
                showMessage('Please provide a date.', 'error');
                document.getElementById('date').focus();
                return false;
            }
            
            if (!data.overview) {
                showMessage('Please provide a project overview.', 'error');
                document.getElementById('projectOverview').focus();
                return false;
            }
            
            if (data.workstreams.length === 0) {
                showMessage('Please add at least one workstream.', 'error');
                return false;
            }
            
            // Validate workstreams
            for (let i = 0; i < data.workstreams.length; i++) {
                const ws = data.workstreams[i];
                if (!ws.workstream) {
                    showMessage(`Please provide a name for workstream ${i + 1}.`, 'error');
                    return false;
                }
                if (!ws.activities) {
                    showMessage(`Please provide key activities for workstream "${ws.workstream}".`, 'error');
                    return false;
                }
                if (!ws.duration || ws.duration <= 0) {
                    showMessage(`Please provide a valid duration for workstream "${ws.workstream}".`, 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        // Validate form data
        function validateFormData(data) {
            // Validate step 1
            if (!validateStep1(data)) {
                return false;
            }
            
            // Validate step 2
            if (data.resources.length === 0) {
                showMessage('Please add at least one resource role.', 'error');
                return false;
            }
            
            // Validate resources
            for (let i = 0; i < data.resources.length; i++) {
                const resource = data.resources[i];
                if (!resource.role) {
                    showMessage(`Please provide a role name for resource ${i + 1}.`, 'error');
                    return false;
                }
                if (!resource.personWeeks && !resource.personHours) {
                    showMessage(`Please provide either person-weeks or person-hours for role "${resource.role}".`, 'error');
                    return false;
                }
            }
            
            if (data.assumptions.length === 0) {
                showMessage('Please add at least one key assumption.', 'error');
                return false;
            }
            
            return true;
        }
        
        // Show message to user
        function showMessage(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Auto-save session data when form changes (debounced)
        let autoSaveTimeout;
        function autoSaveSession() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const formData = collectFormData();
                console.log('🔄 Auto-saving session data...');
                updateSession(formData).catch(error => {
                    console.warn('Auto-save failed:', error);
                });
            }, 2000); // Save 2 seconds after user stops typing
        }
        
        // Collect form data
        function collectFormData() {
            // Collect basic information
            const projectName = document.getElementById('projectName').value.trim();
            const client = document.getElementById('client').value.trim();
            const preparedBy = document.getElementById('preparedBy').value.trim();
            const date = document.getElementById('date').value.trim();
            
            const overview = document.getElementById('projectOverview').value.trim();
            
            // Collect workstream data
            const workstreams = [];
            const workstreamRows = document.querySelectorAll('#workstreamTableBody tr');
            
            workstreamRows.forEach(row => {
                const workstream = row.querySelector('input[name="workstream[]"]').value.trim();
                const activities = row.querySelector('input[name="activities[]"]').value.trim();
                const duration = row.querySelector('input[name="duration[]"]').value.trim();
                
                if (workstream || activities || duration) {
                    workstreams.push({
                        workstream: workstream,
                        activities: activities,
                        duration: parseInt(duration) || 0
                    });
                }
            });
            
            // Collect resource data
            const resources = [];
            const resourceRows = document.querySelectorAll('#resourceTableBody tr');
            
            resourceRows.forEach(row => {
                const role = row.querySelector('input[name="role[]"]').value.trim();
                const weeks = row.querySelector('input[name="personWeeks[]"]').value.trim();
                const hours = row.querySelector('input[name="personHours[]"]').value.trim();
                
                if (role || weeks || hours) {
                    resources.push({
                        role: role,
                        personWeeks: parseFloat(weeks) || 0,
                        personHours: parseInt(hours) || 0
                    });
                }
            });
            
            // Collect buffer data
            const bufferWeeks = parseFloat(document.querySelector('input[name="bufferWeeks"]').value) || 0;
            const bufferHours = parseInt(document.querySelector('input[name="bufferHours"]').value) || 0;
            
            // Collect assumptions
            const assumptions = [];
            const assumptionTextareas = document.querySelectorAll('textarea[name="assumption[]"]');
            
            assumptionTextareas.forEach(textarea => {
                const assumption = textarea.value.trim();
                if (assumption) {
                    assumptions.push(assumption);
                }
            });
            
            // Collect Good options data
            const goodOptions = [];
            const goodRows = document.querySelectorAll('#goodOptionsTableBody tr');
            
            goodRows.forEach(row => {
                const feature = row.querySelector('textarea[name="goodFeature[]"]').value.trim();
                const hours = row.querySelector('input[name="goodHours[]"]').value.trim();
                const weeks = row.querySelector('input[name="goodWeeks[]"]').value.trim();
                
                if (feature || hours || weeks) {
                    goodOptions.push({
                        feature: feature,
                        personHours: parseInt(hours) || 0,
                        personWeeks: parseFloat(weeks) || 0
                    });
                }
            });
            
            // Collect Best options data
            const bestOptions = [];
            const bestRows = document.querySelectorAll('#bestOptionsTableBody tr');
            
            bestRows.forEach(row => {
                const feature = row.querySelector('textarea[name="bestFeature[]"]').value.trim();
                const hours = row.querySelector('input[name="bestHours[]"]').value.trim();
                const weeks = row.querySelector('input[name="bestWeeks[]"]').value.trim();
                
                if (feature || hours || weeks) {
                    bestOptions.push({
                        feature: feature,
                        personHours: parseInt(hours) || 0,
                        personWeeks: parseFloat(weeks) || 0
                    });
                }
            });
            
            return {
                sessionId: sessionId,
                projectName: projectName,
                client: client,
                preparedBy: preparedBy,
                date: date,
                overview: overview,
                workstreams: workstreams,
                resources: resources,
                buffer: {
                    weeks: bufferWeeks,
                    hours: bufferHours
                },
                assumptions: assumptions,
                goodOptions: goodOptions,
                bestOptions: bestOptions
            };
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up initial state
            showStep(1);
            calculateTotals();
            
            // Add event listeners for automatic calculation
            document.addEventListener('input', function(e) {
                if (e.target.name === 'personWeeks[]' || e.target.name === 'personHours[]' || 
                    e.target.name === 'bufferWeeks' || e.target.name === 'bufferHours' ||
                    e.target.name === 'goodHours[]' || e.target.name === 'goodWeeks[]' ||
                    e.target.name === 'bestHours[]' || e.target.name === 'bestWeeks[]') {
                    calculateTotals();
                    updateGoodBestAdjustedTotals();
                }
                
                // Auto-save session data when form changes
                if (e.target.matches('input, textarea, select')) {
                    autoSaveSession();
                }
            });
            
            // Add change listeners for specific form elements
            document.addEventListener('change', function(e) {
                if (e.target.matches('input, textarea, select')) {
                    autoSaveSession();
                }
            });
            
            // Check if this is a loaded session
            const isLoadedSession = {{ 'true' if is_loaded_session else 'false' }};
            console.log('is_loaded_session:', isLoadedSession);
            
            if (isLoadedSession) {
                // Load session data and populate form fields
                console.log('Loading LoE session data...');
                loadSessionData();
            } else {
                // Initial session save with basic structure for new sessions
                const initialData = collectFormData();
                console.log('🚀 Initializing LoE session with basic structure');
                updateSession(initialData).catch(error => {
                    console.warn('Initial session save failed:', error);
                });
            }
            
            // Add event listeners for action buttons
            const previewBtn = document.getElementById('previewLoePdfBtn');
            const generateBtn = document.getElementById('generateLoePdfBtn');
            const saveBtn = document.getElementById('saveLoEBtn');
            const saveDbBtn = document.getElementById('saveLoEToDbBtn');
            const deleteBtn = document.getElementById('deleteLoEBtn');
            
            if (previewBtn) {
                previewBtn.addEventListener('click', previewLoEPdf);
            }
            if (generateBtn) {
                generateBtn.addEventListener('click', generateLoEPdf);
            }
            if (saveBtn) {
                saveBtn.addEventListener('click', saveLoE);
            }
            if (saveDbBtn) {
                saveDbBtn.addEventListener('click', saveLoEToDatabase);
            }
            if (deleteBtn) {
                deleteBtn.addEventListener('click', deleteLoE);
            }
        });
        
        // Load session data and populate form fields
        async function loadSessionData() {
            try {
                console.log('Loading LoE session data for session:', sessionId);
                
                const response = await fetch(`/loe/debug/${sessionId}`);
                console.log('Debug response status:', response.status);
                
                const result = await response.json();
                console.log('Debug response result:', result);
                
                if (result.success && result.data) {
                    const data = result.data;
                    console.log('LoE session data loaded:', data);
                    
                    // Populate basic information fields
                    const basicInfo = data.basic || {};
                    const projectField = document.getElementById('projectName');
                    const clientField = document.getElementById('client');
                    const preparedByField = document.getElementById('preparedBy');
                    const dateField = document.getElementById('date');
                    
                    if (projectField) projectField.value = basicInfo.project || '';
                    if (clientField) clientField.value = basicInfo.client || '';
                    if (preparedByField) preparedByField.value = basicInfo.prepared_by || '';
                    if (dateField) dateField.value = basicInfo.date || '';
                    
                    // Populate project overview
                    const overviewField = document.getElementById('projectOverview');
                    if (overviewField) overviewField.value = data.overview || '';
                    
                    // Populate workstreams
                    if (data.workstreams && data.workstreams.length > 0) {
                        const workstreamTableBody = document.getElementById('workstreamTableBody');
                        if (workstreamTableBody) {
                            // Clear existing rows
                            workstreamTableBody.innerHTML = '';
                            
                            // Add each workstream
                            data.workstreams.forEach((workstream, index) => {
                                if (workstream && workstream.workstream && workstream.workstream.trim()) {
                                    if (index === 0) {
                                        // Add first row
                                        workstreamTableBody.innerHTML = `
                                            <tr>
                                                <td>
                                                    <input type="text" class="form-control" placeholder="e.g., Requirements Analysis" name="workstream[]" value="${workstream.workstream || ''}">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" placeholder="e.g., Stakeholder interviews, documentation review" name="activities[]" value="${workstream.activities || ''}">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="2" min="1" name="duration[]" value="${workstream.duration || ''}">
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeWorkstream(this)" title="Remove workstream">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    } else {
                                        // Add additional rows
                                        addWorkstream();
                                        const newRow = workstreamTableBody.querySelector('tr:last-child');
                                        if (newRow) {
                                            const workstreamInput = newRow.querySelector('input[name="workstream[]"]');
                                            const activitiesInput = newRow.querySelector('input[name="activities[]"]');
                                            const durationInput = newRow.querySelector('input[name="duration[]"]');
                                            
                                            if (workstreamInput) workstreamInput.value = workstream.workstream || '';
                                            if (activitiesInput) activitiesInput.value = workstream.activities || '';
                                            if (durationInput) durationInput.value = workstream.duration || '';
                                        }
                                    }
                                }
                            });
                            
                            // Re-initialize feather icons
                            feather.replace();
                        }
                    }
                    
                    // Populate resources
                    if (data.resources && data.resources.length > 0) {
                        const resourceTableBody = document.getElementById('resourceTableBody');
                        if (resourceTableBody) {
                            // Clear existing rows
                            resourceTableBody.innerHTML = '';
                            
                            // Add each resource
                            data.resources.forEach((resource, index) => {
                                if (resource && resource.role && resource.role.trim()) {
                                    if (index === 0) {
                                        // Add first row
                                        resourceTableBody.innerHTML = `
                                            <tr>
                                                <td>
                                                    <input type="text" class="form-control" placeholder="e.g., Project Manager" name="role[]" value="${resource.role || ''}">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="2.0" step="0.5" min="0" name="personWeeks[]" onchange="updatePersonHours(this)" value="${resource.personWeeks || ''}">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="80" step="10" min="0" name="personHours[]" onchange="updatePersonWeeks(this)" value="${resource.personHours || ''}">
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeResource(this)" title="Remove role">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    } else {
                                        // Add additional rows
                                        addResource();
                                        const newRow = resourceTableBody.querySelector('tr:last-child');
                                        if (newRow) {
                                            const roleInput = newRow.querySelector('input[name="role[]"]');
                                            const weeksInput = newRow.querySelector('input[name="personWeeks[]"]');
                                            const hoursInput = newRow.querySelector('input[name="personHours[]"]');
                                            
                                            if (roleInput) roleInput.value = resource.role || '';
                                            if (weeksInput) weeksInput.value = resource.personWeeks || '';
                                            if (hoursInput) hoursInput.value = resource.personHours || '';
                                        }
                                    }
                                }
                            });
                            
                            // Re-initialize feather icons
                            feather.replace();
                        }
                    }
                    
                    // Populate buffer data
                    if (data.buffer) {
                        const bufferWeeksInput = document.querySelector('input[name="bufferWeeks"]');
                        const bufferHoursInput = document.querySelector('input[name="bufferHours"]');
                        
                        if (bufferWeeksInput) bufferWeeksInput.value = data.buffer.weeks || '';
                        if (bufferHoursInput) bufferHoursInput.value = data.buffer.hours || '';
                    }
                    
                    // Populate assumptions
                    if (data.assumptions && data.assumptions.length > 0) {
                        const assumptionsContainer = document.getElementById('assumptionsContainer');
                        if (assumptionsContainer) {
                            // Clear existing assumptions
                            assumptionsContainer.innerHTML = '';
                            
                            // Add each assumption
                            data.assumptions.forEach((assumption, index) => {
                                if (assumption && assumption.trim()) {
                                    if (index === 0) {
                                        // Add first assumption
                                        assumptionsContainer.innerHTML = `
                                            <div class="assumption-item">
                                                <textarea class="form-control" placeholder="e.g., Client will provide all required documentation within 2 weeks" name="assumption[]">${assumption}</textarea>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeAssumption(this)" title="Remove assumption">
                                                    <i data-feather="trash-2"></i>
                                                </button>
                                            </div>
                                        `;
                                    } else {
                                        // Add additional assumptions
                                        addAssumption();
                                        const newAssumption = assumptionsContainer.querySelector('.assumption-item:last-child');
                                        if (newAssumption) {
                                            const textarea = newAssumption.querySelector('textarea[name="assumption[]"]');
                                            if (textarea) textarea.value = assumption;
                                        }
                                    }
                                }
                            });
                            
                            // Re-initialize feather icons
                            feather.replace();
                        }
                    }

                    // Populate Good Options
                    if (data.goodOptions && data.goodOptions.length > 0) {
                        const goodOptionsTableBody = document.getElementById('goodOptionsTableBody');
                        if (goodOptionsTableBody) {
                            // Clear existing rows
                            goodOptionsTableBody.innerHTML = '';
                            
                            // Add each good option
                            data.goodOptions.forEach((option, index) => {
                                if (option.feature && option.feature.trim()) {
                                    if (index === 0) {
                                        // Add first good option
                                        goodOptionsTableBody.innerHTML = `
                                            <tr>
                                                <td>
                                                    <textarea class="form-control" rows="2" placeholder="e.g., AI-generated draft replies and promotional automation" name="goodFeature[]">${option.feature}</textarea>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="40" step="10" min="0" name="goodHours[]" onchange="updateGoodWeeks(this)" value="${option.personHours || ''}">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="2.0" step="0.5" min="0" name="goodWeeks[]" onchange="updateGoodHours(this)" value="${option.personWeeks || ''}">
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeGoodFeature(this)" title="Remove feature">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    } else {
                                        // Add additional good options
                                        addGoodFeature();
                                        const newRow = goodOptionsTableBody.querySelector('tr:last-child');
                                        if (newRow) {
                                            const featureTextarea = newRow.querySelector('textarea[name="goodFeature[]"]');
                                            const hoursInput = newRow.querySelector('input[name="goodHours[]"]');
                                            const weeksInput = newRow.querySelector('input[name="goodWeeks[]"]');
                                            
                                            if (featureTextarea) featureTextarea.value = option.feature;
                                            if (hoursInput) hoursInput.value = option.personHours || '';
                                            if (weeksInput) weeksInput.value = option.personWeeks || '';
                                        }
                                    }
                                }
                            });
                            
                            // Re-initialize feather icons
                            feather.replace();
                        }
                    }

                    // Populate Best Options
                    if (data.bestOptions && data.bestOptions.length > 0) {
                        const bestOptionsTableBody = document.getElementById('bestOptionsTableBody');
                        if (bestOptionsTableBody) {
                            // Clear existing rows
                            bestOptionsTableBody.innerHTML = '';
                            
                            // Add each best option
                            data.bestOptions.forEach((option, index) => {
                                if (option.feature && option.feature.trim()) {
                                    if (index === 0) {
                                        // Add first best option
                                        bestOptionsTableBody.innerHTML = `
                                            <tr>
                                                <td>
                                                    <textarea class="form-control" rows="2" placeholder="e.g., AI Business Intelligence with predictive analytics" name="bestFeature[]">${option.feature}</textarea>
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="60" step="10" min="0" name="bestHours[]" onchange="updateBestWeeks(this)" value="${option.personHours || ''}">
                                                </td>
                                                <td>
                                                    <input type="number" class="form-control" placeholder="3.0" step="0.5" min="0" name="bestWeeks[]" onchange="updateBestHours(this)" value="${option.personWeeks || ''}">
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeBestFeature(this)" title="Remove feature">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    } else {
                                        // Add additional best options
                                        addBestFeature();
                                        const newRow = bestOptionsTableBody.querySelector('tr:last-child');
                                        if (newRow) {
                                            const featureTextarea = newRow.querySelector('textarea[name="bestFeature[]"]');
                                            const hoursInput = newRow.querySelector('input[name="bestHours[]"]');
                                            const weeksInput = newRow.querySelector('input[name="bestWeeks[]"]');
                                            
                                            if (featureTextarea) featureTextarea.value = option.feature;
                                            if (hoursInput) hoursInput.value = option.personHours || '';
                                            if (weeksInput) weeksInput.value = option.personWeeks || '';
                                        }
                                    }
                                }
                            });
                            
                            // Re-initialize feather icons
                            feather.replace();
                        }
                    }
                    
                    // Recalculate totals after loading all data
                    calculateTotals();
                    updateGoodBestAdjustedTotals();
                    
                    console.log('✅ LoE session data loaded and populated successfully');
                    
                } else {
                    console.error('Failed to load LoE session data:', result.message);
                    showMessage('Failed to load session data: ' + (result.message || 'Unknown error'), 'error');
                }
                
            } catch (error) {
                console.error('Error loading LoE session data:', error);
                showMessage('Error loading session data: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 