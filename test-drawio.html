<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io PostMessage Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #fff;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0052a3;
        }
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.event { color: #4ade80; }
        .log-entry.action { color: #60a5fa; }
        .log-entry.error { color: #f87171; }
        .log-entry.info { color: #a78bfa; }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            border-radius: 8px;
            background: white;
        }
        .preview {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .preview img {
            max-width: 100%;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .xml-output {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            color: #4ade80;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.ready { background: #065f46; color: #d1fae5; }
        .status.waiting { background: #92400e; color: #fef3c7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Draw.io PostMessage Test Harness</h1>
        
        <div class="controls">
            <h3>
                Editor Status: 
                <span id="status" class="status waiting">Waiting for init...</span>
            </h3>
            
            <div style="margin-top: 15px;">
                <button onclick="loadBlankDiagram()">üìÑ Load Blank Diagram</button>
                <button onclick="loadSampleDiagram()">üìä Load Sample Diagram</button>
                <button onclick="exportPNG()">üñºÔ∏è Export PNG</button>
                <button onclick="exportXMLPNG()">üì¶ Export PNG+XML</button>
                <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            </div>
        </div>

        <div class="log" id="log">
            <div class="log-entry info">üîÑ Loading draw.io editor...</div>
        </div>

        <iframe 
            id="drawio-iframe"
            src="https://app.diagrams.net/?embed=1&proto=json&spin=1&libraries=1&noSaveBtn=1&ui=atlas"
            title="Draw.io Editor"
        ></iframe>

        <div class="preview">
            <h3>üì∏ Export Preview</h3>
            <div id="preview-area">
                <p style="color: #888;">PNG export will appear here...</p>
            </div>
        </div>

        <div class="preview">
            <h3>üìù XML Output</h3>
            <div id="xml-output" class="xml-output">
                XML will appear here after save/autosave...
            </div>
        </div>
    </div>

    <script>
        let isInitialized = false;
        let currentXML = null;

        // Get iframe reference
        const iframe = document.getElementById('drawio-iframe');
        const statusEl = document.getElementById('status');

        // Listen for messages from draw.io
        window.addEventListener('message', function(event) {
            // For testing, we'll accept messages from diagrams.net
            // In production, validate origin strictly
            if (!event.origin.includes('diagrams.net') && !event.origin.includes('draw.io')) {
                log('‚ö†Ô∏è Ignored message from unknown origin: ' + event.origin, 'error');
                return;
            }

            let message;
            try {
                message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
            } catch (e) {
                log('‚ùå Failed to parse message: ' + e.message, 'error');
                return;
            }

            const messageType = message.event || message.action || 'unknown';
            
            // Log the message
            log(`üì® Received: ${messageType}`, message.event ? 'event' : 'action');
            console.log('Full message:', message);

            // Handle different message types
            switch (message.event) {
                case 'init':
                    isInitialized = true;
                    statusEl.textContent = 'Ready ‚úì';
                    statusEl.className = 'status ready';
                    log('‚úÖ Editor initialized and ready!', 'event');
                    break;

                case 'autosave':
                    currentXML = message.xml;
                    log('üíæ Autosave triggered', 'event');
                    displayXML(message.xml);
                    break;

                case 'save':
                    currentXML = message.xml;
                    log('üíæ Manual save triggered', 'event');
                    displayXML(message.xml);
                    break;

                case 'export':
                    log('üñºÔ∏è Export received!', 'event');
                    displayPNG(message.data, message.xml);
                    break;

                case 'exit':
                    log('üö™ Editor exit event', 'event');
                    break;

                case 'configure':
                    log('‚öôÔ∏è Configure event (not used)', 'event');
                    break;

                default:
                    log(`‚ÑπÔ∏è Unknown event: ${messageType}`, 'info');
            }
        });

        // Send message to draw.io
        function sendToDrawio(message) {
            if (!iframe.contentWindow) {
                log('‚ùå iframe not ready', 'error');
                return;
            }

            log(`üì§ Sending: ${message.action || message.event}`, 'action');
            console.log('Sending message:', message);
            
            iframe.contentWindow.postMessage(JSON.stringify(message), '*');
        }

        // Load blank diagram
        function loadBlankDiagram() {
            if (!isInitialized) {
                log('‚ö†Ô∏è Wait for editor to initialize first', 'error');
                return;
            }

            const blankXML = '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>';
            
            sendToDrawio({
                action: 'load',
                xml: blankXML,
                autosave: 1
            });

            log('üìÑ Loading blank diagram...', 'action');
        }

        // Load sample diagram
        function loadSampleDiagram() {
            if (!isInitialized) {
                log('‚ö†Ô∏è Wait for editor to initialize first', 'error');
                return;
            }

            const sampleXML = `<mxGraphModel>
                <root>
                    <mxCell id="0"/>
                    <mxCell id="1" parent="0"/>
                    <mxCell id="2" value="Start" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
                        <mxGeometry x="200" y="40" width="120" height="60" as="geometry"/>
                    </mxCell>
                    <mxCell id="3" value="Process" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
                        <mxGeometry x="200" y="140" width="120" height="60" as="geometry"/>
                    </mxCell>
                    <mxCell id="4" value="End" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
                        <mxGeometry x="200" y="240" width="120" height="60" as="geometry"/>
                    </mxCell>
                    <mxCell id="5" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="2" target="3">
                        <mxGeometry width="50" height="50" relative="1" as="geometry"/>
                    </mxCell>
                    <mxCell id="6" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="3" target="4">
                        <mxGeometry width="50" height="50" relative="1" as="geometry"/>
                    </mxCell>
                </root>
            </mxGraphModel>`;
            
            sendToDrawio({
                action: 'load',
                xml: sampleXML,
                autosave: 1
            });

            log('üìä Loading sample flowchart...', 'action');
        }

        // Export PNG
        function exportPNG() {
            if (!isInitialized) {
                log('‚ö†Ô∏è Wait for editor to initialize first', 'error');
                return;
            }

            sendToDrawio({
                action: 'export',
                format: 'png'
            });

            log('üñºÔ∏è Requesting PNG export...', 'action');
        }

        // Export PNG with embedded XML (xmlpng)
        function exportXMLPNG() {
            if (!isInitialized) {
                log('‚ö†Ô∏è Wait for editor to initialize first', 'error');
                return;
            }

            sendToDrawio({
                action: 'export',
                format: 'xmlpng'
            });

            log('üì¶ Requesting PNG+XML export...', 'action');
        }

        // Display PNG
        function displayPNG(base64Data, xml) {
            const previewArea = document.getElementById('preview-area');
            
            // Check if it's a data URI or just base64
            const imgSrc = base64Data.startsWith('data:') ? base64Data : `data:image/png;base64,${base64Data}`;
            
            previewArea.innerHTML = `
                <img src="${imgSrc}" alt="Exported diagram" style="max-width: 100%; border: 1px solid #444; border-radius: 4px;">
                <p style="color: #888; font-size: 12px; margin-top: 10px;">
                    üìä Size: ${Math.round(base64Data.length / 1024)} KB
                    ${xml ? '| ‚úÖ Contains embedded XML' : ''}
                </p>
            `;

            log('‚úÖ PNG displayed successfully', 'event');
        }

        // Display XML
        function displayXML(xml) {
            const xmlOutput = document.getElementById('xml-output');
            const formatted = xml.replace(/></g, '>\n<');
            xmlOutput.textContent = formatted;
            
            log(`üìù XML updated (${xml.length} chars)`, 'info');
        }

        // Logging function
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Clear log
        function clearLog() {
            const logEl = document.getElementById('log');
            logEl.innerHTML = '<div class="log-entry info">üìã Log cleared</div>';
        }

        // Initial load message
        log('üîÑ Waiting for draw.io to send init event...', 'info');
    </script>
</body>
</html>

